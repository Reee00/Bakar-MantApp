<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover" />
    <meta name="description" content="Bakar Mantap - Pesan Nasi Bakar Asli Indonesia Online" />
    <meta name="theme-color" content="#ff6b35" />
    <title>Bakar Mantap - Nasi Bakar Asli Indonesia</title>

    <link rel="manifest" href="manifest.json" />
    <link rel="icon" type="image/png" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>üî•</text></svg>">

    <style>
        :root{
            --primary-color:#ff6b35;
            --primary-dark:#e55a2b;
            --secondary-color:#f7931e;
            --text-dark:#333;
            --text-light:#666;
            --text-muted:#999;
            --bg-light:#f8f9fa;
            --border-color:#ddd;
            --success-color:#4caf50;
            --error-color:#f44336;
            --warning-color:#ff9800;
            --shadow-sm:0 4px 15px rgba(0,0,0,0.08);
            --shadow-md:0 8px 25px rgba(0,0,0,0.12);
            --shadow-lg:0 20px 40px rgba(0,0,0,0.18);
            --transition:all 0.25s ease;
        }

        *{box-sizing: border-box}
        html,body{height:100%}
        body{
            margin:0;
            font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,Ubuntu,Cantarell,'Helvetica Neue',sans-serif;
            background:linear-gradient(135deg,#f5f7fa 0%,#c3cfe2 100%);
            display:flex;
            align-items:center;
            justify-content:center;
            padding:24px;
            -webkit-font-smoothing:antialiased;
            -moz-osx-font-smoothing:grayscale;
            min-height:100vh;
            overflow:auto;
        }

        /* PHONE FRAME (responsive) */
        .phone-container{
            width:min(420px, calc(100% - 48px));
            height:min(860px, calc(100vh - 48px));
            background:#000;
            border-radius:28px;
            padding:8px;
            box-shadow:var(--shadow-lg);
            display:flex;
            align-items:center;
            justify-content:center;
        }

        /* Internal screen area (where absolute elements are positioned relative to) */
        .screen{
            width:100%;
            height:100%;
            background:#fff;
            border-radius:22px;
            overflow:hidden;
            position:relative; /* important for absolute children */
            display:block;
        }

        /* STATUS BAR */
        .status-bar{
            height:44px;
            display:flex;
            align-items:center;
            justify-content:space-between;
            padding:0 16px;
            font-weight:600;
            font-size:14px;
            background:transparent;
            color:var(--text-dark);
            position:sticky;
            top:0;
            z-index:20;
        }

        /* PAGES */
        .page{display:none;height:calc(100% - 44px);overflow:auto;padding-bottom:160px}
        .page.active{display:block}

        /* Buttons used inline styles elsewhere rely on these classes */
        .icon-btn { width:40px; height:40px; display:inline-flex; align-items:center; justify-content:center; border-radius:20px; border:none; background:rgba(255,255,255,0.12); color:#fff; cursor:pointer; }
        .cart-badge { position:relative; display:inline-flex; min-width:18px; height:18px; align-items:center; justify-content:center; background:var(--error-color); color:#fff; border-radius:9px; padding:0 6px; font-size:11px; font-weight:700; margin-left:6px }

        /* Menu categories */
        .category-btn { padding:8px 14px; border-radius:20px; border:1.5px solid var(--primary-color); background:#fff; color:var(--primary-color); font-weight:700; cursor:pointer; white-space:nowrap }
        .category-btn.active { background:var(--primary-color); color:#fff }

        /* Menu items */
        .menu-items .menu-item { display:flex; gap:12px; align-items:center; padding:12px; border-radius:12px; box-shadow:var(--shadow-sm); background:#fff; margin-bottom:12px }
        .menu-items .item-image { width:64px; height:64px; border-radius:10px; display:flex; align-items:center; justify-content:center; font-size:28px; color:#fff; background:linear-gradient(135deg,var(--primary-color),var(--secondary-color)) }

        /* cart styles */
        .cart-content{padding-bottom:220px}
        .cart-items{padding:20px}
        .cart-item{
            display:flex;
            gap:12px;
            align-items:flex-start;
            background:#fff;
            border-radius:12px;
            padding:12px;
            box-shadow:var(--shadow-sm);
            margin-bottom:12px;
            width:100%;
            overflow:hidden;
        }
        .cart-item .item-image{
            width:64px;
            height:64px;
            border-radius:10px;
            display:flex;
            align-items:center;
            justify-content:center;
            font-size:28px;
            flex-shrink:0;
            background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));
            color:#fff;
        }
        .cart-item-info{flex:1;min-width:0}
        .cart-item-name{font-weight:600;color:var(--text-dark);margin-bottom:5px}
        .cart-item-details{font-size:12px;color:var(--text-muted);margin-bottom:6px}
        .cart-item-price{color:var(--primary-color);font-weight:700}

        .cart-qty-controls{display:flex;align-items:center;gap:8px;background:var(--bg-light);padding:6px;border-radius:18px}
        .cart-qty-btn{width:34px;height:34px;border-radius:17px;border:none;background:white;cursor:pointer;color:var(--primary-color)}
        .remove-item-btn{background:none;border:none;color:var(--error-color);cursor:pointer;font-size:20px}

        .checkout-summary{
            background:white;
            margin:16px;
            padding:16px;
            border-radius:12px;
            box-shadow:var(--shadow-sm);
            max-width:calc(100% - 32px);
        }

        /* CHECKOUT BUTTON: absolute & centered within .screen */
        .checkout-btn{
            position:absolute;
            left:50%;
            transform:translateX(-50%);
            bottom:92px; /* default above bottom-nav */
            z-index:60;
            width:calc(100% - 64px);
            max-width:340px;
            background:var(--primary-color);
            color:white;
            border:none;
            padding:14px 18px;
            border-radius:24px;
            font-weight:700;
            cursor:pointer;
            box-shadow:var(--shadow-md);
            transition:var(--transition);
        }
        .checkout-btn:hover{transform:translateX(-50%) translateY(-2px); background:var(--primary-dark)}

        /* BOTTOM NAV: absolute to .screen so it always sticks to phone frame */
        .bottom-nav{
            position:absolute;
            left:12px;
            right:12px;
            bottom:12px;
            height:auto;
            background:white;
            display:flex;
            justify-content:space-between;
            align-items:center;
            padding:8px 12px;
            border-radius:14px;
            box-shadow:0 6px 18px rgba(0,0,0,0.06);
            z-index:70;
            gap:8px;
        }
        .nav-item{
            display:flex;
            flex-direction:column;
            align-items:center;
            gap:4px;
            padding:6px 8px;
            border-radius:10px;
            cursor:pointer;
            flex:1 1 0;
            min-width:48px;
            max-width:110px;
            text-align:center;
        }
        .nav-item .nav-icon{font-size:20px}
        .nav-item .nav-label{font-size:11px}
        .nav-item.active{background:rgba(255,107,53,0.06);color:var(--primary-color)}

        /* Modal basics */
        .modal-overlay{display:none;position:fixed;inset:0;align-items:center;justify-content:center;background:rgba(0,0,0,0.45);z-index:200}
        .modal{background:#fff;border-radius:12px;padding:18px;max-width:320px;width:90%}

        /* small-screen adjustments */
        @media (max-width:420px){
            body{padding:12px}
            .phone-container{width:100%;height:100vh;padding:0;border-radius:0}
            .screen{border-radius:0;height:100vh}
            .page{height:calc(100% - 44px);padding-bottom:160px}
            .checkout-btn{bottom:110px;width:calc(100% - 48px);max-width:none}
            .bottom-nav{left:8px;right:8px;border-radius:12px;padding:8px}
        }

        /* larger viewport ‚Äî keep phone frame centered */
        @media (min-width:900px){
            body{background:linear-gradient(180deg,#eef3f8 0%,#d7e0ec 100%)}
            .phone-container{transform:scale(1);box-shadow:0 18px 50px rgba(0,0,0,0.12)}
            .screen{height:calc(100%);}
            .checkout-btn{bottom:92px}
        }

        /* Accessibility focus outlines */
        :focus{outline:2px solid rgba(255,107,53,0.18);outline-offset:2px}
        @keyframes spin { 0% { transform: rotate(0deg);} 100% { transform: rotate(360deg); } }
              .action-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr);
        gap: 15px;
      }

      .action-card {
        background: white;
        padding: 20px;
        border-radius: 15px;
        text-align: center;
        box-shadow: var(--shadow-sm);
        cursor: pointer;
        transition: var(--transition);
        position: relative;
        overflow: hidden;
      }

      .action-card::before {
        content: "";
        position: absolute;
        top: 0;
        left: 0;
        right: 0;
        height: 3px;
        background: linear-gradient(
          90deg,
          var(--primary-color),
          var(--secondary-color)
        );
        transform: translateX(-100%);
        transition: var(--transition);
      }

      .action-card:hover {
        transform: translateY(-3px);
        box-shadow: var(--shadow-md);
      }

      .action-card:hover::before {
        transform: translateX(0);
      }

      .action-icon {
        font-size: 30px;
        margin-bottom: 10px;
      }

      .action-title {
        font-weight: 600;
        color: var(--text-dark);
      }

      .action-subtitle {
        font-size: 12px;
        color: var(--text-muted);
        margin-top: 5px;
      }
    </style>
</head>
<body>
    <div class="phone-container">
        <div class="screen">
            <div class="status-bar">
                <span id="current-time">9:41</span>
                <span>‚óâ‚óâ‚óâ‚óâ‚óâ 100%</span>
            </div>

            <!-- Splash -->
            <div class="page active" id="splash">
                <div style="padding:40px;text-align:center;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));color:#fff;height:100%;display:flex;flex-direction:column;justify-content:center;align-items:center;">
                    <button class="skip-btn" onclick="showPage('home')" aria-label="Skip intro" style="position:absolute;right:18px;top:18px;background:rgba(255,255,255,0.15);border:none;color:#fff;padding:8px 14px;border-radius:18px;cursor:pointer">Skip</button>
                    <div class="logo" role="img" aria-label="Bakar Mantap Logo" style="width:110px;height:110px;border-radius:22px;background:rgba(255,255,255,0.18);display:flex;align-items:center;justify-content:center;font-size:54px;">üî•</div>
                    <h1 style="margin-top:18px;font-size:28px">Bakar Mantap</h1>
                    <p style="opacity:0.95;margin-top:6px">Nasi Bakar Asli Indonesia</p>
                    <button onclick="showPage('home')" style="margin-top:20px;background:#fff;color:var(--primary-color);padding:12px 28px;border-radius:22px;border:none;font-weight:700;cursor:pointer">Mulai Pesan</button>
                </div>
            </div>

            <!-- Home -->
            <div class="page" id="home">
                <div style="background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));padding:16px;color:#fff;">
                    <div style="display:flex;justify-content:space-between;align-items:center">
                        <div onclick="openLocationModal()" role="button" style="cursor:pointer">üìç <span id="current-location">Jakarta Selatan</span></div>
                        <div style="display:flex;gap:8px">
                            <button class="icon-btn" onclick="openFavoritesModal()">‚ù§Ô∏è</button>
                            <button class="icon-btn" onclick="showPage('cart')">üõí <span class="cart-badge" id="cart-count" aria-live="polite" style="display:none">0</span></button>
                        </div>
                    </div>
                    <h2 id="greeting" style="margin:14px 0 4px 0;font-size:20px">Selamat Datang!</h2>
                    <p style="opacity:0.95">Pilih nasi bakar favoritmu</p>
                </div>

                <div style="padding:16px">
                    <div style="position:relative;margin:8px 0">
                        <input id="search-input" class="search-input" placeholder="Cari menu favorit..." aria-label="Search menu items" style="width:100%;padding:12px 44px 12px 40px;border-radius:24px;border:1px solid var(--border-color);background:var(--bg-light)">
                        <span style="position:absolute;left:14px;top:50%;transform:translateY(-50%);color:var(--text-muted)">üîç</span>
                        <button id="clear-search" onclick="clearSearch()" aria-label="Clear search" style="position:absolute;right:12px;top:50%;transform:translateY(-50%);display:none;background:var(--text-muted);color:#fff;border-radius:50%;width:26px;height:26px;border:none">√ó</button>
                    </div>

                    <h3 style="margin-top:12px">Menu Populer</h3>

                    <div class="action-grid" style="margin-top:8px;display:grid;grid-template-columns:repeat(2,1fr);gap:12px">
                        <div class="action-card" onclick="filterAndShowMenu('all')" role="button" tabindex="0" aria-label="Nasi Bakar" style="padding:12px;border-radius:12px;background:#fff;box-shadow:var(--shadow-sm);text-align:center">
                            <div class="action-icon" style="font-size:22px">üçö</div>
                            <div class="action-title" style="font-weight:700;margin-top:6px">Nasi Bakar</div>
                            <div class="action-subtitle" style="color:var(--text-muted);font-size:13px">15+ pilihan</div>
                        </div>

                        <div class="action-card" onclick="showComingSoon('Minuman')" role="button" tabindex="0" aria-label="Minuman" style="padding:12px;border-radius:12px;background:#fff;box-shadow:var(--shadow-sm);text-align:center">
                            <div class="action-icon" style="font-size:22px">ü•§</div>
                            <div class="action-title" style="font-weight:700;margin-top:6px">Minuman</div>
                            <div class="action-subtitle" style="color:var(--text-muted);font-size:13px">Segera hadir</div>
                        </div>

                        <div class="action-card" onclick="showPromotions()" role="button" tabindex="0" aria-label="Promo" style="padding:12px;border-radius:12px;background:#fff;box-shadow:var(--shadow-sm);text-align:center">
                            <div class="action-icon" style="font-size:22px">üéØ</div>
                            <div class="action-title" style="font-weight:700;margin-top:6px">Promo</div>
                            <div class="action-subtitle" style="color:var(--text-muted);font-size:13px">Lihat Diskon</div>
                        </div>

                        <div class="action-card" onclick="showComingSoon('Poin')" role="button" tabindex="0" aria-label="Poin Saya" style="padding:12px;border-radius:12px;background:#fff;box-shadow:var(--shadow-sm);text-align:center">
                            <div class="action-icon" style="font-size:22px">‚≠ê</div>
                            <div class="action-title" style="font-weight:700;margin-top:6px">Poin Saya</div>
                            <div class="action-subtitle" style="color:var(--text-muted);font-size:13px">Kumpulkan poin</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Menu -->
            <div class="page" id="menu">
                <div style="padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #f0f0f0">
                    <button class="back-btn" onclick="showPage('home')" aria-label="Back" style="border:none;background:none;color:var(--primary-color);font-size:18px;cursor:pointer">‚Üê</button>
                    <h2 style="margin:0;font-size:18px">Menu Nasi Bakar</h2>
                </div>

                <div style="padding:12px;display:flex;gap:8px;overflow:auto">
                    <button class="category-btn active" data-category="all" onclick="filterMenu('all')">Semua</button>
                    <button class="category-btn" data-category="ayam" onclick="filterMenu('ayam')">Ayam</button>
                    <button class="category-btn" data-category="seafood" onclick="filterMenu('seafood')">Seafood</button>
                    <button class="category-btn" data-category="paket" onclick="filterMenu('paket')">Paket</button>
                </div>

                <div id="menu-items-list" class="menu-items" role="list" style="padding:12px">
                    <!-- generated by JS -->
                </div>
            </div>

            <!-- Product detail -->
            <div class="page" id="product-detail">
                <div style="padding:12px">
                    <div class="product-detail">
                        <div class="product-image-container" style="height:240px;background:linear-gradient(135deg,var(--primary-color),var(--secondary-color));display:flex;align-items:center;justify-content:center;position:relative;border-radius:12px;margin-bottom:12px">
                            <button class="back-btn-detail" onclick="showPage('menu')" aria-label="Back to menu" style="position:absolute;left:12px;top:12px;background:rgba(255,255,255,0.18);border:none;color:#fff;border-radius:18px;padding:8px;cursor:pointer">‚Üê</button>
                            <button class="favorite-btn-detail" id="favorite-btn-detail" onclick="toggleFavoriteDetail()" aria-label="Add to favorites" style="position:absolute;right:12px;top:12px;background:rgba(255,255,255,0.18);border:none;color:#fff;border-radius:18px;padding:8px;cursor:pointer">ü§ç</button>
                            <div class="product-image-large" id="product-emoji" role="img" aria-label="Product image" style="font-size:80px;color:#fff">üçó</div>
                        </div>

                        <h2 id="product-title" style="margin:6px 0">Nasi Bakar Ayam</h2>
                        <div class="product-price" id="product-price" style="color:var(--primary-color);font-weight:700;margin-bottom:8px">Rp 25.000</div>
                        <div class="product-description" id="product-desc" style="color:var(--text-muted);margin-bottom:12px">Deskripsi</div>

                        <div class="customization" style="margin-bottom:12px">
                            <div style="font-weight:700;margin-bottom:8px">Level Kepedasan</div>
                            <div class="spice-options" role="radiogroup" aria-label="Spice level" style="display:flex;gap:8px;flex-wrap:wrap">
                                <div class="spice-option selected" onclick="selectSpice(this)" role="radio" aria-checked="true" tabindex="0" style="padding:8px 12px;border-radius:18px;border:2px solid var(--border-color);cursor:pointer;background:#fff">Tidak Pedas</div>
                                <div class="spice-option" onclick="selectSpice(this)" role="radio" aria-checked="false" tabindex="0" style="padding:8px 12px;border-radius:18px;border:2px solid var(--border-color);cursor:pointer;background:#fff">Sedang</div>
                                <div class="spice-option" onclick="selectSpice(this)" role="radio" aria-checked="false" tabindex="0" style="padding:8px 12px;border-radius:18px;border:2px solid var(--border-color);cursor:pointer;background:#fff">Pedas</div>
                                <div class="spice-option" onclick="selectSpice(this)" role="radio" aria-checked="false" tabindex="0" style="padding:8px 12px;border-radius:18px;border:2px solid var(--border-color);cursor:pointer;background:#fff">Extra Pedas</div>
                            </div>
                        </div>

                        <div class="quantity-selector" role="group" aria-label="Quantity selector" style="display:flex;align-items:center;justify-content:center;gap:20px;margin-bottom:12px">
                            <button class="qty-btn" onclick="changeQuantity(-1)" aria-label="Decrease quantity" id="qty-minus" style="padding:8px 12px;border-radius:18px;border:2px solid var(--primary-color);background:#fff;color:var(--primary-color);cursor:pointer">‚àí</button>
                            <span class="qty-display" id="quantity" aria-live="polite">1</span>
                            <button class="qty-btn" onclick="changeQuantity(1)" aria-label="Increase quantity" id="qty-plus" style="padding:8px 12px;border-radius:18px;border:2px solid var(--primary-color);background:#fff;color:var(--primary-color);cursor:pointer">+</button>
                        </div>

                        <button class="add-to-cart-btn" onclick="addToCartFromDetail()" aria-label="Add to cart" style="width:100%;background:var(--primary-color);color:#fff;padding:12px;border-radius:18px;border:none;cursor:pointer">Tambah ke Keranjang <span id="total-price" style="margin-left:8px">Rp 25.000</span></button>
                    </div>
                </div>
            </div>

            <!-- Cart -->
            <div class="page" id="cart">
                <div style="padding:12px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid #f0f0f0">
                    <button class="back-btn" onclick="showPage('home')" aria-label="Back" style="border:none;background:none;color:var(--primary-color);font-size:18px;cursor:pointer">‚Üê</button>
                    <h2 style="margin:0;font-size:18px">Keranjang Belanja</h2>
                </div>

                <div class="cart-content">
                    <div class="cart-items" id="cart-items-container" role="list">
                        <!-- cart items will be dynamically added here -->
                    </div>

                    <div class="checkout-summary" id="checkout-summary">
                        <div style="display:flex;gap:8px;align-items:center;margin-bottom:12px">
                            <input id="promo-input" class="promo-input" placeholder="Masukkan kode promo" style="flex:1;padding:10px;border-radius:18px;border:1px solid var(--border-color)">
                            <button class="apply-promo-btn" onclick="applyPromoCode()" style="background:var(--primary-color);color:#fff;border:none;padding:10px 12px;border-radius:18px;cursor:pointer">Pakai</button>
                        </div>

                        <div id="promo-applied-container"></div>

                        <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Subtotal</span><span id="subtotal">Rp 0</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Pajak (10%)</span><span id="tax">Rp 0</span></div>
                        <div style="display:flex;justify-content:space-between;margin-bottom:8px"><span>Ongkir</span><span id="delivery-fee">Rp 10.000</span></div>
                        <div style="display:flex;justify-content:space-between;margin-top:8px;font-weight:700"><span>Total</span><span id="total">Rp 0</span></div>
                    </div>
                </div>

                <button class="checkout-btn" id="checkout-button" onclick="proceedToCheckout()">Lanjut ke Pembayaran</button>
            </div>

            <!-- modal overlay -->
            <div id="modal-overlay" class="modal-overlay" onclick="closeModalOnOverlay(event)">
                <div id="modal-content" class="modal" role="dialog" aria-modal="true"></div>
            </div>

            <!-- bottom nav -->
            <nav class="bottom-nav" role="navigation" aria-label="Main navigation">
                <div class="nav-item active" onclick="showPage('home'); setActiveNav(this)" role="button" tabindex="0" aria-label="Home">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-label">Home</span>
                </div>
                <div class="nav-item" onclick="showPage('menu'); setActiveNav(this)" role="button" tabindex="0" aria-label="Menu">
                    <span class="nav-icon">üìã</span>
                    <span class="nav-label">Menu</span>
                </div>
                <div class="nav-item" onclick="showPage('cart'); setActiveNav(this)" role="button" tabindex="0" aria-label="Cart">
                    <span class="nav-icon">üõí</span>
                    <span class="nav-label">Keranjang</span>
                </div>
                <div class="nav-item" onclick="showComingSoon('Profil')" role="button" tabindex="0" aria-label="Profile">
                    <span class="nav-icon">üë§</span>
                    <span class="nav-label">Profil</span>
                </div>
            </nav>
        </div>
    </div>

<script>
    // ===== GLOBAL STATE =====
    let cart = [];
    let favorites = new Set();
    let currentQuantity = 1;
    let currentPrice = 25000;
    let currentProduct = null;
    let currentLocation = 'Jakarta Selatan';
    let appliedPromo = null;
    let appliedPromoCode = null;
    let maxQuantityPerItem = 20;

    // ===== PRODUCT DATABASE =====
    const products = {
        ayam: {
            id: 'ayam',
            name: 'Nasi Bakar Ayam',
            price: 25000,
            emoji: 'üçó',
            category: 'ayam',
            description: 'Nasi yang dimasak dengan santan kelapa kemudian dibakar dengan daun pisang hingga harum. Disajikan dengan potongan ayam yang telah dibumbui.',
            spiceLevel: 3,
            rating: 4.8,
            reviews: 150,
            preparationTime: 15
        },
        cumi: {
            id: 'cumi',
            name: 'Nasi Bakar Cumi',
            price: 28000,
            emoji: 'ü¶ë',
            category: 'seafood',
            description: 'Nasi bakar dengan cumi segar yang dimasak dengan bumbu rica-rica pedas manis.',
            spiceLevel: 4,
            rating: 4.7,
            reviews: 120,
            preparationTime: 20
        },
        tuna: {
            id: 'tuna',
            name: 'Nasi Bakar Tuna',
            price: 30000,
            emoji: 'üêü',
            category: 'seafood',
            description: 'Nasi bakar dengan ikan tuna segar yang dimasak dengan bumbu woku khas Manado.',
            spiceLevel: 2,
            rating: 4.9,
            reviews: 200,
            preparationTime: 18
        },
        teri: {
            id: 'teri',
            name: 'Nasi Bakar Teri',
            price: 22000,
            emoji: 'üê†',
            category: 'ayam',
            description: 'Nasi bakar dengan teri medan yang digoreng crispy dan dibumbui balado.',
            spiceLevel: 2,
            rating: 4.6,
            reviews: 95,
            preparationTime: 12
        },
        udang: {
            id: 'udang',
            name: 'Nasi Bakar Udang',
            price: 32000,
            emoji: 'ü¶ê',
            category: 'seafood',
            description: 'Nasi bakar dengan udang segar ukuran jumbo yang dimasak dengan bumbu spesial.',
            spiceLevel: 3,
            rating: 4.8,
            reviews: 180,
            preparationTime: 20
        },
        paket1: {
            id: 'paket1',
            name: 'Paket Hemat Ayam',
            price: 35000,
            emoji: 'üç±',
            category: 'paket',
            description: 'Paket hemat berisi Nasi Bakar Ayam, minuman es teh manis, dan kerupuk.',
            spiceLevel: 2,
            rating: 4.7,
            reviews: 130,
            preparationTime: 15
        },
        paket2: {
            id: 'paket2',
            name: 'Paket Seafood Special',
            price: 50000,
            emoji: 'üéÅ',
            category: 'paket',
            description: 'Paket spesial dengan Nasi Bakar Udang dan Cumi, lengkap dengan minuman dan kerupuk.',
            spiceLevel: 4,
            rating: 4.9,
            reviews: 85,
            preparationTime: 25
        },
        bebek: {
            id: 'bebek',
            name: 'Nasi Bakar Bebek',
            price: 35000,
            emoji: 'ü¶Ü',
            category: 'ayam',
            description: 'Nasi bakar dengan bebek goreng crispy yang empuk dan gurih.',
            spiceLevel: 3,
            rating: 4.8,
            reviews: 110,
            preparationTime: 30
        }
    };

    // ===== PROMO CODES =====
    const promoCodes = {
        'BAKAR20': { discount: 0.20, description: 'Diskon 20%' },
        'MANTAP15': { discount: 0.15, description: 'Diskon 15%' },
        'NEWUSER': { discount: 0.25, description: 'Diskon 25% untuk pengguna baru' },
        'GRATIS': { discount: 0, freeDelivery: true, description: 'Gratis ongkir' }
    };

    // ===== LOCATIONS =====
    const locations = [
        'Jakarta Pusat',
        'Jakarta Selatan',
        'Jakarta Utara',
        'Jakarta Timur',
        'Jakarta Barat',
        'Tangerang',
        'Bekasi',
        'Depok',
        'Bogor'
    ];

    // ===== INITIALIZATION =====
    document.addEventListener('DOMContentLoaded', function() {
        loadFromLocalStorage();
        updateCurrentTime();
        setInterval(updateCurrentTime, 60000);
        updateGreeting();
        generateMenuItems();
        setupSearch();
        setupKeyboardNavigation();
        updateCartCount();
        updateCartDisplay();
        renderAppliedPromoUI();
    });

    // ===== LOCAL STORAGE =====
    function saveToLocalStorage() {
        try {
            localStorage.setItem('cart', JSON.stringify(cart));
            localStorage.setItem('favorites', JSON.stringify([...favorites]));
            localStorage.setItem('currentLocation', currentLocation);
            localStorage.setItem('appliedPromoCode', appliedPromoCode || '');
        } catch (e) {
            console.error('Error saving to localStorage:', e);
        }
    }

    function loadFromLocalStorage() {
        try {
            const savedCart = localStorage.getItem('cart');
            if (savedCart) {
                cart = JSON.parse(savedCart);
            }

            const savedFavorites = localStorage.getItem('favorites');
            if (savedFavorites) {
                favorites = new Set(JSON.parse(savedFavorites));
            }

            const savedLocation = localStorage.getItem('currentLocation');
            if (savedLocation) {
                currentLocation = savedLocation;
                const locEl = document.getElementById('current-location');
                if (locEl) locEl.textContent = currentLocation;
            }

            const savedPromoCode = localStorage.getItem('appliedPromoCode');
            if (savedPromoCode) {
                appliedPromoCode = savedPromoCode || null;
                if (appliedPromoCode && promoCodes[appliedPromoCode]) {
                    appliedPromo = promoCodes[appliedPromoCode];
                } else {
                    appliedPromo = null;
                    appliedPromoCode = null;
                }
            }

            normalizeCart();
        } catch (e) {
            console.error('Error loading from localStorage:', e);
        }
    }

    // Ensure each cart item has expected fields and types
    function normalizeCart() {
        if (!Array.isArray(cart)) cart = [];
        cart = cart.map(item => {
            const prod = products[item && item.id] || {};
            const price = Number(item && item.price);
            const quantity = Number(item && item.quantity);
            return {
                id: item && item.id ? item.id : (prod.id || 'unknown'),
                name: item && item.name ? item.name : (prod.name || 'Produk'),
                price: Number.isFinite(price) && price > 0 ? price : (prod.price || 0),
                quantity: Number.isFinite(quantity) && quantity > 0 ? Math.floor(quantity) : 1,
                emoji: item && item.emoji ? item.emoji : (prod.emoji || 'üçΩÔ∏è'),
                spiceLevel: (item && item.spiceLevel) ? item.spiceLevel : 'Default'
            };
        });
    }

    // ===== UTILITIES =====
    function updateCurrentTime() {
        const now = new Date();
        const hours = String(now.getHours()).padStart(2, '0');
        const minutes = String(now.getMinutes()).padStart(2, '0');
        const el = document.getElementById('current-time');
        if (el) el.textContent = `${hours}:${minutes}`;
    }

    function updateGreeting() {
        const hour = new Date().getHours();
        let greeting = 'Selamat Datang!';
        if (hour >= 5 && hour < 12) greeting = 'Selamat Pagi!';
        else if (hour >= 12 && hour < 15) greeting = 'Selamat Siang!';
        else if (hour >= 15 && hour < 18) greeting = 'Selamat Sore!';
        else greeting = 'Selamat Malam!';
        const el = document.getElementById('greeting');
        if (el) el.textContent = greeting;
    }

    function formatPrice(price) {
        return 'Rp ' + Number(price).toLocaleString('id-ID');
    }

    // ===== PAGE NAVIGATION =====
    function showPage(pageId) {
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        const targetPage = document.getElementById(pageId);
        if (targetPage) {
            targetPage.classList.add('active');
            targetPage.scrollTop = 0;
            if (pageId === 'cart') updateCartDisplay();
            else if (pageId === 'menu') {
                const activeCategory = document.querySelector('.category-btn.active');
                if (activeCategory) filterMenu(activeCategory.dataset.category);
            }
        }
    }

    function setActiveNav(element) {
        document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
        element.classList.add('active');
    }

    // ===== MENU GENERATION =====
    function generateMenuItems() {
        const container = document.getElementById('menu-items-list');
        if (!container) return;
        container.innerHTML = '';

        Object.values(products).forEach(product => {
            const item = document.createElement('div');
            item.className = 'menu-item';
            item.dataset.category = product.category;
            item.dataset.productId = product.id;
            item.setAttribute('role', 'listitem');

            item.innerHTML = `
                <div class="item-image" role="img" aria-label="${product.name}">${product.emoji}</div>
                <div style="flex:1;min-width:0">
                    <div style="display:flex;justify-content:space-between;align-items:flex-start">
                        <div style="font-weight:700">${product.name}</div>
                        <div style="color:var(--primary-color);font-weight:700">${formatPrice(product.price)}</div>
                    </div>
                    <div style="color:var(--text-muted);font-size:13px;margin-top:6px">${product.description}</div>
                </div>
                <div style="display:flex;flex-direction:column;gap:8px;align-items:flex-end">
                    <button class="add-btn" aria-label="Add ${product.name} to cart">+</button>
                    <button class="favorite-btn" aria-label="Toggle favorite">${favorites.has(product.id) ? '‚ù§Ô∏è' : 'ü§ç'}</button>
                </div>
            `;

            // Click handlers
            item.querySelector('.add-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                addToCart(product.id);
            });

            item.querySelector('.favorite-btn').addEventListener('click', (e) => {
                e.stopPropagation();
                toggleFavorite(product.id);
            });

            item.addEventListener('click', () => showProductDetail(product.id));
            container.appendChild(item);
        });
    }

    // ===== SEARCH =====
    function setupSearch() {
        const searchInput = document.getElementById('search-input');
        const clearBtn = document.getElementById('clear-search');
        if (!searchInput) return;

        searchInput.addEventListener('input', function(e) {
            const query = e.target.value.trim().toLowerCase();
            if (clearBtn) clearBtn.style.display = query.length > 0 ? 'inline-flex' : 'none';

            const menuItems = document.querySelectorAll('.menu-item');
            menuItems.forEach(item => {
                const productId = item.dataset.productId;
                const product = products[productId];
                const matchesSearch = product.name.toLowerCase().includes(query) ||
                                      product.description.toLowerCase().includes(query);
                item.style.display = matchesSearch ? '' : 'none';
            });
            checkEmptyState();
        });
    }

    function clearSearch() {
        const searchInput = document.getElementById('search-input');
        if (searchInput) searchInput.value = '';
        const clearBtn = document.getElementById('clear-search');
        if (clearBtn) clearBtn.style.display = 'none';
        document.querySelectorAll('.menu-item').forEach(item => item.style.display = '');
        checkEmptyState();
    }

    function checkEmptyState() {
        const container = document.getElementById('menu-items-list');
        const visibleItems = container ? container.querySelectorAll('.menu-item:not([style*="display: none"])') : [];
        const existing = container ? container.querySelector('.empty-state') : null;
        if (existing) existing.remove();
        if (visibleItems.length === 0) {
            const emptyState = document.createElement('div');
            emptyState.className = 'empty-state';
            emptyState.style.textAlign = 'center';
            emptyState.style.padding = '40px 12px';
            emptyState.innerHTML = `
                <div style="font-size:36px">üîç</div>
                <h3 style="margin-top:10px">Tidak Ada Hasil</h3>
                <p style="color:var(--text-muted)">Coba kata kunci lain atau lihat semua menu kami</p>
                <button class="modal-btn modal-btn-primary" style="margin-top:12px;padding:10px 16px;border-radius:12px;border:none;background:var(--primary-color);color:#fff" onclick="clearSearch(); filterMenu('all')">Lihat Semua Menu</button>
            `;
            container.appendChild(emptyState);
        }
    }

    // ===== FILTER =====
    function filterMenu(category) {
        document.querySelectorAll('.category-btn').forEach(btn => {
            btn.classList.toggle('active', btn.dataset.category === category);
        });

        clearSearch();

        document.querySelectorAll('.menu-item').forEach(item => {
            const itemCategory = item.dataset.category;
            const shouldShow = category === 'all' || itemCategory === category;
            item.style.display = shouldShow ? '' : 'none';
        });

        checkEmptyState();
    }

    function filterAndShowMenu(category) {
        showPage('menu');
        setTimeout(() => filterMenu(category), 100);
    }

          function showPromotions() {
        const promoList = Object.entries(promoCodes)
          .map(([code, promo]) => {
            return `
                <div style="padding: 15px; border: 2px dashed var(--primary-color); border-radius: 10px; margin-bottom: 10px; background: rgba(255,107,53,0.05);">
                    <div style="font-weight: 600; color: var(--primary-color); margin-bottom: 5px;">üéüÔ∏è ${code}</div>
                    <div style="font-size: 14px; color: var(--text-light);">${promo.description}</div>
                </div>
            `;
          })
          .join("");

        showModal(
          "Promo Tersedia",
          `<p style="margin-bottom: 15px;">Gunakan kode promo di bawah ini saat checkout:</p>${promoList}`,
          [{ label: "OK", action: closeModal, className: "modal-btn-primary" }]
        );
      }

    // ===== PRODUCT DETAIL =====
    function showProductDetail(productId) {
        const product = products[productId];
        if (!product) return;

        currentProduct = product;
        currentPrice = product.price;
        currentQuantity = 1;

        // Populate detail page fields
        const emojiEl = document.getElementById('product-emoji');
        const titleEl = document.getElementById('product-title');
        const priceEl = document.getElementById('product-price');
        const descEl = document.getElementById('product-desc');
        const qtyEl = document.getElementById('quantity');
        const totalPriceEl = document.getElementById('total-price');
        const favBtn = document.getElementById('favorite-btn-detail');

        if (emojiEl) emojiEl.textContent = product.emoji;
        if (titleEl) titleEl.textContent = product.name;
        if (priceEl) priceEl.textContent = formatPrice(product.price);
        if (descEl) descEl.textContent = product.description;
        if (qtyEl) qtyEl.textContent = '1';
        if (totalPriceEl) totalPriceEl.textContent = formatPrice(product.price);
        if (favBtn) { favBtn.textContent = favorites.has(product.id) ? '‚ù§Ô∏è' : 'ü§ç'; favBtn.setAttribute('aria-label', favorites.has(product.id) ? 'Hapus dari favorit' : 'Tambah ke favorit'); }

        // Reset spice options (first selected)
        document.querySelectorAll('.spice-option').forEach((el, i) => {
            el.classList.toggle('selected', i === 0);
            el.setAttribute('aria-checked', i === 0 ? 'true' : 'false');
        });

        updateQuantityButtons();
        showPage('product-detail');
    }

    function selectSpice(element) {
        document.querySelectorAll('.spice-option').forEach(el => {
            el.classList.remove('selected');
            el.setAttribute('aria-checked', 'false');
        });
        element.classList.add('selected');
        element.setAttribute('aria-checked', 'true');
    }

    function changeQuantity(change) {
        const newQuantity = currentQuantity + change;
        if (newQuantity >= 1 && newQuantity <= maxQuantityPerItem) {
            currentQuantity = newQuantity;
            const qtyEl = document.getElementById('quantity');
            if (qtyEl) qtyEl.textContent = currentQuantity;
            const totalPriceEl = document.getElementById('total-price');
            if (totalPriceEl) totalPriceEl.textContent = formatPrice(currentPrice * currentQuantity);
            updateQuantityButtons();
        }
    }

    function updateQuantityButtons() {
        const minusBtn = document.getElementById('qty-minus');
        const plusBtn = document.getElementById('qty-plus');
        if (minusBtn) minusBtn.disabled = currentQuantity <= 1;
        if (plusBtn) plusBtn.disabled = currentQuantity >= maxQuantityPerItem;
    }

    // ===== CART =====
    function addToCart(productId) {
        const product = products[productId];
        if (!product) return;

        const existingItem = cart.find(item => item.id === productId && item.spiceLevel === 'Default');
        if (existingItem) {
            if (existingItem.quantity < maxQuantityPerItem) {
                existingItem.quantity += 1;
                showToast(`${product.name} ditambahkan ke keranjang`, 'success');
            } else {
                showToast(`Maksimal ${maxQuantityPerItem} item per produk`, 'warning');
                return;
            }
        } else {
            cart.push({
                id: productId,
                name: product.name,
                price: product.price,
                quantity: 1,
                emoji: product.emoji,
                spiceLevel: 'Default'
            });
            showToast(`${product.name} ditambahkan ke keranjang`, 'success');
        }

        normalizeCart();
        updateCartCount();
        saveToLocalStorage();
        updateCartDisplay();
    }

    function addToCartFromDetail() {
        if (!currentProduct) return;

        const selectedSpiceEl = document.querySelector('.spice-option.selected');
        const selectedSpice = selectedSpiceEl ? selectedSpiceEl.textContent : 'Default';
        const existingItem = cart.find(item =>
            item.id === currentProduct.id && item.spiceLevel === selectedSpice
        );

        if (existingItem) {
            const newQuantity = existingItem.quantity + currentQuantity;
            if (newQuantity <= maxQuantityPerItem) {
                existingItem.quantity = newQuantity;
            } else {
                showToast(`Maksimal ${maxQuantityPerItem} item per produk`, 'warning');
                return;
            }
        } else {
            cart.push({
                id: currentProduct.id,
                name: currentProduct.name,
                price: currentProduct.price,
                quantity: currentQuantity,
                emoji: currentProduct.emoji,
                spiceLevel: selectedSpice
            });
        }

        normalizeCart();
        updateCartCount();
        saveToLocalStorage();
        showToast(`${currentProduct.name} ditambahkan ke keranjang`, 'success');
        showPage('menu');
    }

    function removeFromCart(index) {
        if (index < 0 || index >= cart.length) return;
        showConfirmation(
            'Hapus Item',
            `Apakah Anda yakin ingin menghapus ${cart[index].name} dari keranjang?`,
            () => {
                cart.splice(index, 1);
                normalizeCart();
                updateCartCount();
                updateCartDisplay();
                saveToLocalStorage();
                showToast('Item dihapus dari keranjang', 'success');
            }
        );
    }

    function updateCartItemQuantity(index, change) {
        if (!cart[index]) return;
        const newQuantity = cart[index].quantity + change;
        if (newQuantity <= 0) {
            removeFromCart(index);
        } else if (newQuantity <= maxQuantityPerItem) {
            cart[index].quantity = newQuantity;
            normalizeCart();
            updateCartDisplay();
            updateCartCount();
            saveToLocalStorage();
        } else {
            showToast(`Maksimal ${maxQuantityPerItem} item per produk`, 'warning');
        }
    }

    function updateCartCount() {
        const totalItems = cart.reduce((sum, item) => sum + (Number(item.quantity) || 0), 0);
        const badges = document.querySelectorAll('.cart-badge');
        badges.forEach(badge => {
            badge.textContent = totalItems;
            badge.style.display = totalItems > 0 ? 'inline-flex' : 'none';
        });
    }

    // Build cart DOM (safer)
    function updateCartDisplay() {
        normalizeCart();
        const container = document.getElementById('cart-items-container');
        const checkoutBtn = document.getElementById('checkout-button');
        if (!container) return;
        container.innerHTML = '';

        if (cart.length === 0) {
            container.innerHTML = `
                <div style="text-align:center;padding:28px;color:var(--text-muted)">
                    <div style="font-size:36px">üõí</div>
                    <div style="font-weight:700;margin-top:8px">Keranjang Kosong</div>
                    <div style="margin-top:8px">Tambahkan menu favorit Anda</div>
                </div>
            `;
            const summary = document.getElementById('checkout-summary');
            if (summary) summary.style.display = 'none';
            if (checkoutBtn) checkoutBtn.style.display = 'none';
            document.getElementById('subtotal').textContent = formatPrice(0);
            document.getElementById('tax').textContent = formatPrice(0);
            document.getElementById('delivery-fee').textContent = formatPrice(0);
            document.getElementById('total').textContent = formatPrice(0);
            return;
        }

        const summary = document.getElementById('checkout-summary');
        if (summary) summary.style.display = 'block';
        if (checkoutBtn) checkoutBtn.style.display = 'block';

        let subtotal = 0;

        cart.forEach((item, index) => {
            const price = Number(item.price) || (products[item.id] ? products[item.id].price : 0);
            const quantity = Number(item.quantity) || 1;
            const spice = item.spiceLevel || 'Default';
            const emoji = item.emoji || (products[item.id] ? products[item.id].emoji : 'üçΩÔ∏è');
            const itemTotal = price * quantity;
            subtotal += itemTotal;

            const cartItemEl = document.createElement('div');
            cartItemEl.className = 'cart-item';

            const imgEl = document.createElement('div');
            imgEl.className = 'item-image';
            imgEl.textContent = emoji;

            const infoEl = document.createElement('div');
            infoEl.className = 'cart-item-info';

            const nameEl = document.createElement('div');
            nameEl.className = 'cart-item-name';
            nameEl.textContent = item.name;

            const detailsEl = document.createElement('div');
            detailsEl.className = 'cart-item-details';
            detailsEl.textContent = `Level: ${spice}`;

            const priceEl = document.createElement('div');
            priceEl.className = 'cart-item-price';
            priceEl.textContent = `${formatPrice(price)} √ó ${quantity} = ${formatPrice(itemTotal)}`;

            infoEl.appendChild(nameEl);
            infoEl.appendChild(detailsEl);
            infoEl.appendChild(priceEl);

            const controlsWrap = document.createElement('div');
            controlsWrap.style.display = 'flex';
            controlsWrap.style.flexDirection = 'column';
            controlsWrap.style.justifyContent = 'space-between';
            controlsWrap.style.alignItems = 'center';
            controlsWrap.style.gap = '10px';

            const qtyControls = document.createElement('div');
            qtyControls.className = 'cart-qty-controls';
            qtyControls.setAttribute('role', 'group');
            qtyControls.setAttribute('aria-label', 'Quantity controls');

            const minusBtn = document.createElement('button');
            minusBtn.className = 'cart-qty-btn';
            minusBtn.textContent = '‚àí';
            minusBtn.title = 'Kurangi jumlah';
            minusBtn.addEventListener('click', () => updateCartItemQuantity(index, -1));

            const qtyDisplay = document.createElement('span');
            qtyDisplay.setAttribute('aria-live', 'polite');
            qtyDisplay.textContent = quantity;

            const plusBtn = document.createElement('button');
            plusBtn.className = 'cart-qty-btn';
            plusBtn.textContent = '+';
            plusBtn.title = 'Tambah jumlah';
            plusBtn.addEventListener('click', () => updateCartItemQuantity(index, 1));

            qtyControls.appendChild(minusBtn);
            qtyControls.appendChild(qtyDisplay);
            qtyControls.appendChild(plusBtn);

            const removeBtn = document.createElement('button');
            removeBtn.className = 'remove-item-btn';
            removeBtn.title = 'Hapus item';
            removeBtn.innerHTML = 'üóëÔ∏è';
            removeBtn.addEventListener('click', () => removeFromCart(index));

            controlsWrap.appendChild(qtyControls);
            controlsWrap.appendChild(removeBtn);

            cartItemEl.appendChild(imgEl);
            cartItemEl.appendChild(infoEl);
            cartItemEl.appendChild(controlsWrap);

            container.appendChild(cartItemEl);
        });

        let discount = 0;
        let deliveryFee = 10000;

        if (appliedPromo) {
            if (appliedPromo.discount) discount = Math.round(subtotal * appliedPromo.discount);
            if (appliedPromo.freeDelivery) deliveryFee = 0;
        }

        const tax = Math.round((subtotal - discount) * 0.1);
        const total = subtotal - discount + tax + deliveryFee;

        document.getElementById('subtotal').textContent = formatPrice(subtotal);
        document.getElementById('tax').textContent = formatPrice(tax);
        document.getElementById('delivery-fee').textContent = deliveryFee === 0 ? 'GRATIS' : formatPrice(deliveryFee);
        document.getElementById('total').textContent = formatPrice(total);

        const discountRow = document.getElementById('discount-row');
        if (discountRow) {
            if (discount > 0) {
                discountRow.style.display = 'flex';
                document.getElementById('discount').textContent = '- ' + formatPrice(discount);
            } else {
                discountRow.style.display = 'none';
            }
        }
    }

    // ===== PROMO CODE =====
    function applyPromoCode() {
        const input = document.getElementById('promo-input');
        const code = input ? input.value.trim().toUpperCase() : '';
        if (!code) {
            showToast('Masukkan kode promo', 'warning');
            return;
        }
        if (appliedPromo) {
            showToast('Hanya bisa menggunakan 1 promo', 'warning');
            return;
        }
        const promo = promoCodes[code];
        if (promo) {
            appliedPromo = promo;
            appliedPromoCode = code;
            if (input) input.value = '';
            renderAppliedPromoUI();
            updateCartDisplay();
            showToast('Promo berhasil digunakan!', 'success');
            saveToLocalStorage();
        } else {
            showToast('Kode promo tidak valid', 'error');
        }
    }

    function renderAppliedPromoUI() {
        const container = document.getElementById('promo-applied-container');
        if (!container) return;
        container.innerHTML = '';
        if (appliedPromo) {
            const div = document.createElement('div');
            div.className = 'promo-applied';
            div.style.display = 'flex';
            div.style.justifyContent = 'space-between';
            div.style.alignItems = 'center';
            div.style.background = 'var(--success-color)';
            div.style.color = '#fff';
            div.style.padding = '8px 12px';
            div.style.borderRadius = '10px';
            div.innerHTML = `<span>üéâ ${appliedPromo.description}</span>`;
            const btn = document.createElement('button');
            btn.className = 'remove-promo';
            btn.setAttribute('aria-label', 'Remove promo');
            btn.style.background = 'none';
            btn.style.border = 'none';
            btn.style.color = '#fff';
            btn.style.fontSize = '18px';
            btn.style.cursor = 'pointer';
            btn.innerHTML = '√ó';
            btn.addEventListener('click', removePromo);
            div.appendChild(btn);
            container.appendChild(div);
        }
    }

    function removePromo() {
        appliedPromo = null;
        appliedPromoCode = null;
        renderAppliedPromoUI();
        updateCartDisplay();
        showToast('Promo dihapus', 'success');
        saveToLocalStorage();
    }

    // ===== FAVORITES =====
    function toggleFavorite(productId) {
        if (favorites.has(productId)) {
            favorites.delete(productId);
            showToast('Dihapus dari favorit', 'success');
        } else {
            favorites.add(productId);
            showToast('Ditambahkan ke favorit', 'success');
        }
        const menuItem = document.querySelector(`.menu-item[data-product-id="${productId}"]`);
        if (menuItem) {
            const favBtn = menuItem.querySelector('.favorite-btn');
            if (favBtn) {
                favBtn.textContent = favorites.has(productId) ? '‚ù§Ô∏è' : 'ü§ç';
                favBtn.setAttribute('aria-label', favorites.has(productId) ? 'Hapus dari favorit' : 'Tambah ke favorit');
            }
        }
        const favDetailBtn = document.getElementById('favorite-btn-detail');
        if (favDetailBtn && currentProduct && currentProduct.id === productId) {
            favDetailBtn.textContent = favorites.has(productId) ? '‚ù§Ô∏è' : 'ü§ç';
            favDetailBtn.setAttribute('aria-label', favorites.has(productId) ? 'Hapus dari favorit' : 'Tambah ke favorit');
        }
        saveToLocalStorage();
    }

    function toggleFavoriteDetail() {
        if (!currentProduct) return;
        toggleFavorite(currentProduct.id);
    }

    function openFavoritesModal() {
        if (favorites.size === 0) {
            showModal(
                'Favorit',
                `<div style="text-align:center;padding:20px;color:var(--text-muted)">
                    <div style="font-size:36px">‚ù§Ô∏è</div>
                    <h3 style="margin-top:8px">Belum Ada Favorit</h3>
                    <p>Tambahkan menu favorit Anda dengan menekan ‚ù§Ô∏è</p>
                </div>`,
                [{ label: 'Tutup', action: closeModal, className: 'modal-btn-secondary' }]
            );
            return;
        }

        const favoritesList = [...favorites].map(id => {
            const product = products[id];
            return `
                <div style="display:flex;align-items:center;justify-content:space-between;padding:10px;border-bottom:1px solid #f0f0f0;cursor:pointer" onclick="closeModal(); showProductDetail('${id}')">
                    <div style="display:flex;gap:10px;align-items:center">
                        <div style="font-size:24px">${product.emoji}</div>
                        <div>
                            <div style="font-weight:700">${product.name}</div>
                            <div style="color:var(--primary-color);font-weight:700">${formatPrice(product.price)}</div>
                        </div>
                    </div>
                    <button onclick="event.stopPropagation(); toggleFavorite('${id}'); openFavoritesModal();" class="favorite-btn" style="border:none;background:none;cursor:pointer">‚ùå</button>
                </div>
            `;
        }).join('');

        showModal('Menu Favorit', `<div style="max-height:60vh;overflow:auto">${favoritesList}</div>`, [{ label: 'Tutup', action: closeModal, className: 'modal-btn-secondary' }]);
    }

    // ===== LOCATION =====
    function openLocationModal() {
        const locationsList = locations.map(loc => {
            const isActive = loc === currentLocation;
            return `<div style="padding:12px;border-bottom:1px solid #f0f0f0;display:flex;align-items:center;gap:10px;cursor:pointer" onclick="selectLocation('${loc}')">
                        <div>${isActive ? 'üìç' : 'üìå'}</div>
                        <div style="${isActive ? 'color:var(--primary-color);font-weight:700' : ''}">${loc}</div>
                    </div>`;
        }).join('');

        showModal('Pilih Lokasi', `<div style="max-height:50vh;overflow:auto">${locationsList}</div>`, [{ label: 'Tutup', action: closeModal, className: 'modal-btn-secondary' }]);
    }

    function selectLocation(location) {
        currentLocation = location;
        const locEl = document.getElementById('current-location');
        if (locEl) locEl.textContent = location;
        saveToLocalStorage();
        showToast(`Lokasi diubah ke ${location}`, 'success');
        closeModal();
    }

    // ===== MODALS (DOM-safe) =====
    function showModal(title, body, actions = []) {
        const overlay = document.getElementById('modal-overlay');
        const modalContent = document.getElementById('modal-content');
        if (!overlay || !modalContent) return;

        modalContent.innerHTML = '';
        const header = document.createElement('div');
        header.style.display = 'flex';
        header.style.justifyContent = 'space-between';
        header.style.alignItems = 'center';
        header.style.marginBottom = '12px';
        const h3 = document.createElement('h3');
        h3.textContent = title;
        h3.style.margin = '0';
        header.appendChild(h3);

        const closeBtn = document.createElement('button');
        closeBtn.className = 'modal-close';
        closeBtn.setAttribute('aria-label', 'Close modal');
        closeBtn.innerHTML = '√ó';
        closeBtn.style.border = 'none';
        closeBtn.style.background = 'none';
        closeBtn.style.fontSize = '20px';
        closeBtn.style.cursor = 'pointer';
        closeBtn.addEventListener('click', closeModal);
        header.appendChild(closeBtn);

        modalContent.appendChild(header);

        const bodyEl = document.createElement('div');
        bodyEl.className = 'modal-body';
        bodyEl.innerHTML = body;
        modalContent.appendChild(bodyEl);

        if (actions && actions.length > 0) {
            const actionsWrap = document.createElement('div');
            actionsWrap.className = 'modal-actions';
            actionsWrap.style.display = 'flex';
            actionsWrap.style.gap = '8px';
            actions.forEach(act => {
                const btn = document.createElement('button');
                btn.className = 'modal-btn ' + (act.className || 'modal-btn-primary');
                btn.type = 'button';
                btn.textContent = act.label || 'OK';
                btn.style.padding = '10px 12px';
                btn.style.borderRadius = '10px';
                btn.style.cursor = 'pointer';
                if (act.className && act.className.includes('secondary')) {
                    btn.style.background = 'var(--bg-light)';
                    btn.style.border = 'none';
                } else if (act.className && act.className.includes('danger')) {
                    btn.style.background = 'var(--error-color)';
                    btn.style.color = '#fff';
                } else {
                    btn.style.background = 'var(--primary-color)';
                    btn.style.color = '#fff';
                }
                btn.addEventListener('click', function() {
                    if (typeof act.action === 'function') {
                        try { act.action(act.params); } catch (err) { console.error(err); }
                    } else if (typeof act.action === 'string' && typeof window[act.action] === 'function') {
                        try { window[act.action](act.params); } catch (err) { console.error(err); }
                    }
                    closeModal();
                });
                actionsWrap.appendChild(btn);
            });
            modalContent.appendChild(actionsWrap);
        }

        overlay.style.display = 'flex';
        modalContent.tabIndex = -1;
        modalContent.focus();
    }

    function closeModal() {
        const overlay = document.getElementById('modal-overlay');
        if (overlay) overlay.style.display = 'none';
    }

    function closeModalOnOverlay(event) {
        if (event.target.id === 'modal-overlay') closeModal();
    }

    function showConfirmation(title, message, onConfirm) {
        showModal(title, `<div style="text-align:center"><div style="font-size:36px">‚ö†Ô∏è</div><p>${message}</p></div>`, [
            { label: 'Batal', action: closeModal, className: 'modal-btn-secondary' },
            { label: 'Ya, Hapus', action: () => { onConfirm(); }, className: 'modal-btn-danger' }
        ]);
    }

    function showComingSoon(feature) {
        showModal('Segera Hadir', `<div style="text-align:center"><div style="font-size:36px">üöÄ</div><p>Fitur <strong>${feature}</strong> akan segera hadir! Stay tuned.</p></div>`, [
            { label: 'OK', action: closeModal, className: 'modal-btn-primary' }
        ]);
    }

    // ===== CHECKOUT / ORDER =====
    function proceedToCheckout() {
        if (cart.length === 0) {
            showToast('Keranjang masih kosong', 'warning');
            return;
        }

        const subtotal = cart.reduce((sum, item) => sum + (Number(item.price) || 0) * (Number(item.quantity) || 0), 0);
        let discount = 0;
        let deliveryFee = 10000;
        if (appliedPromo) {
            if (appliedPromo.discount) discount = Math.round(subtotal * appliedPromo.discount);
            if (appliedPromo.freeDelivery) deliveryFee = 0;
        }
        const tax = Math.round((subtotal - discount) * 0.1);
        const total = subtotal - discount + tax + deliveryFee;

        showModal('Konfirmasi Pesanan', `
            <div style="text-align:center">
                <div style="font-size:36px">üéâ</div>
                <p>Pesanan Anda akan segera diproses</p>
                <div style="background:var(--bg-light);padding:12px;border-radius:10px;margin-top:12px;text-align:left">
                    <div style="display:flex;justify-content:space-between"><span>Total Items:</span><strong>${cart.reduce((s,i)=>s+(i.quantity||0),0)} item</strong></div>
                    <div style="display:flex;justify-content:space-between"><span>Lokasi:</span><strong>${currentLocation}</strong></div>
                    <div style="display:flex;justify-content:space-between;margin-top:10px;font-size:18px;border-top:1px solid #eee;padding-top:10px"><span>Total Bayar:</span><strong style="color:var(--primary-color)">${formatPrice(total)}</strong></div>
                </div>
            </div>
        `, [
            { label: 'Batal', action: closeModal, className: 'modal-btn-secondary' },
            { label: 'Konfirmasi Pesanan', action: confirmOrder, className: 'modal-btn-primary' }
        ]);
    }

    function confirmOrder() {
        closeModal();
        showLoading('Memproses pesanan...');
        setTimeout(() => {
            hideLoading();
            cart = [];
            appliedPromo = null;
            appliedPromoCode = null;
            normalizeCart();
            updateCartCount();
            saveToLocalStorage();
            updateCartDisplay();

            showModal('Pesanan Berhasil! üéâ', `
                <div style="text-align:center">
                    <div style="font-size:36px">‚úÖ</div>
                    <p><strong>Terima kasih atas pesanan Anda!</strong></p>
                    <p>Nomor pesanan: <strong>#BM${Date.now().toString().slice(-6)}</strong></p>
                    <p>Pesanan Anda sedang diproses dan akan diantarkan dalam 30-45 menit.</p>
                </div>
            `, [
                { label: 'Kembali ke Home', action: () => { showPage('home'); }, className: 'modal-btn-primary' }
            ]);
        }, 1600);
    }

    // ===== LOADING / TOAST =====
    function showLoading(message = 'Memuat...') {
        const overlay = document.createElement('div');
        overlay.className = 'loading-overlay';
        overlay.id = 'loading-overlay';
        overlay.style.position = 'fixed';
        overlay.style.inset = 0;
        overlay.style.display = 'flex';
        overlay.style.alignItems = 'center';
        overlay.style.justifyContent = 'center';
        overlay.style.background = 'rgba(255,255,255,0.9)';
        overlay.style.zIndex = 9999;
        overlay.innerHTML = `<div style="text-align:center"><div style="width:40px;height:40px;border:4px solid rgba(255,107,53,0.15);border-top-color:var(--primary-color);border-radius:50%;animation:spin 1s linear infinite"></div><div style="margin-top:12px;font-weight:700">${message}</div></div>`;
        document.body.appendChild(overlay);
    }

    function hideLoading() {
        const overlay = document.getElementById('loading-overlay');
        if (overlay) overlay.remove();
    }

    function showToast(message, type = 'default') {
        const toast = document.createElement('div');
        toast.className = `toast ${type}`;
        toast.textContent = message;
        toast.setAttribute('role', 'alert');
        toast.setAttribute('aria-live', 'polite');
        toast.style.position = 'fixed';
        toast.style.left = '50%';
        toast.style.transform = 'translateX(-50%)';
        toast.style.bottom = '110px';
        toast.style.background = (type === 'success' ? 'var(--success-color)' : (type === 'error' ? 'var(--error-color)' : (type === 'warning' ? 'var(--warning-color)' : 'rgba(0,0,0,0.85)')));
        toast.style.color = '#fff';
        toast.style.padding = '10px 16px';
        toast.style.borderRadius = '20px';
        toast.style.zIndex = 2000;
        document.body.appendChild(toast);
        setTimeout(() => {
            toast.style.opacity = '0';
            setTimeout(() => { if (toast.parentNode) toast.parentNode.removeChild(toast); }, 300);
        }, 3000);
    }

    // ===== KEYBOARD / ACCESSIBILITY =====
    function setupKeyboardNavigation() {
        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('modal-overlay');
                if (modal && modal.style.display === 'flex') closeModal();
            }
            if ((e.ctrlKey || e.metaKey) && e.key === 'k') {
                e.preventDefault();
                const searchInput = document.getElementById('search-input');
                if (searchInput) searchInput.focus();
            }
        });

        document.querySelectorAll('[role="button"]').forEach(el => {
            if (!el.hasAttribute('tabindex')) el.setAttribute('tabindex', '0');
            el.addEventListener('keydown', function(e) {
                if (e.key === 'Enter' || e.key === ' ') {
                    e.preventDefault();
                    el.click();
                }
            });
        });
    }

    // ===== SERVICE WORKER (PWA) =====
    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            // navigator.serviceWorker.register('/sw.js');
        });
    }
</script>
</body>
</html>
